blueprint:
    name: V2 Philips Hue Tap Dial Volume Control
    description: Uses Zigbee2MQTT connected Tap Dial to control media player volume
    domain: automation
    author: Ronaldo Pace
    input:
        # The philips hue tap dial device connected to the Zigbee2MQTT
        mqtt_topic:
            name: MQTT Topic
            description: The MQTT topic for the Philips Hue Tap Dial.<br><br>
                This is composed by combining:<br>
                - the MQTT base name (defaults to 'zigbee2mqtt')<br>
                - the slash '/' symbol <br>
                - the name of the device <br><br>
                The value can be found on Zigbee2MQTT page for the device under 'MQTT' section.<br>
                Example 'zigbee2mqtt/Living Room Volume Control'
        # The media player entity
        target_media_player:
            name: Media Player Entity
            description: The media player to control the volume
            selector:
                entity:
                    domain: media_player
                    multiple: false

# triggers everytime a new message arrives at the mqtt
triggers:
    -   trigger: mqtt
        topic: !input mqtt_topic

conditions:
    # only change volume while playing
    -   condition: state
        entity_id: !input target_media_player
        state:
            - playing
    # only process the proper mqtt payloads
    -   condition: template
        value_template: >-
            {{ trigger.payload_json.action == 'brightness_step_up' or
            trigger.payload_json.action == 'brightness_step_down' }}

actions:

    # computes the volume change proportional to the tap dial step
    -   variables:
            step: "{{ trigger.payload_json.action_step_size / 423.0 }}"
            action: "{{ trigger.payload_json.action }}"
            player_id: !input target_media_player
            volume: "{{ state_attr(player_id, 'volume_level') }}"

    -   choose:
            -   alias: Volume Up
                conditions:
                    -   condition: template
                        value_template: "{{ action == 'brightness_step_up' }}"
                sequence:
                    -   action: media_player.volume_set
                        metadata: { }
                        data:
                            volume_level: "{{ [(volume + step), 1.0]|min }}"
                        target:
                            entity_id: !input target_media_player

            -   alias: Volume Down
                conditions:
                    -   condition: template
                        value_template: "{{ action == 'brightness_step_down' }}"
                sequence:
                    -   action: media_player.volume_set
                        metadata: { }
                        data_template:
                            volume_level: "{{ [(volume - step), 0.0]|max }}"
                        target:
                            entity_id: !input target_media_player
mode: queued
max: 20
